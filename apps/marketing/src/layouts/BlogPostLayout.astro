---
import DefaultLayout from "@marketing/layouts/DefaultLayout.astro";
import TableOfContents from "@marketing/components/TableOfContents.astro";
import CTA from "@marketing/components/CTA.astro";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { MARKETING_URL } from "astro:env/server";

type Heading = {
  depth: number;
  slug: string;
  text: string;
};

type Props = {
  title: string;
  description: string;
  pubDate: Date;
  author: string;
  image: {
    src: ImageMetadata;
    alt: string;
  };
  headings: Heading[];
  ctaHeadline?: string;
  slug: string;
  readingTime: number;
};

const {
  title,
  description,
  pubDate,
  author,
  image,
  headings,
  ctaHeadline,
  slug,
  readingTime,
} = Astro.props;
const siteUrl = MARKETING_URL ?? "https://blinkdisk.com";
const ogImage = `/blog/og/${slug}.png`;

const formattedDate = pubDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: `${siteUrl}${image.src.src}`,
  datePublished: pubDate.toISOString(),
  author: {
    "@type": "Person",
    name: author,
  },
  publisher: {
    "@type": "Organization",
    name: "BlinkDisk",
  },
};
---

<DefaultLayout
  title={title}
  description={description}
  image={image.src.src}
  og={{ title, image: ogImage }}
  structuredData={blogPostingSchema}
>
  <article class="pt-page pb-page mx-auto w-[90vw] max-w-3xl lg:max-w-4xl">
    <header class="mb-12">
      <h1 class="text-foreground mb-8 text-3xl font-bold md:text-4xl">
        {title}
      </h1>
      <div class="text-foreground/60 mb-6 flex flex-wrap gap-x-8 gap-y-2">
        <div>
          <span class="block text-sm">Published on</span>
          <span class="text-foreground">{formattedDate}</span>
        </div>
        <div>
          <span class="block text-sm">Written by</span>
          <span class="text-foreground">{author}</span>
        </div>
        <div>
          <span class="block text-sm">Reading time</span>
          <span class="text-foreground">{readingTime} min read</span>
        </div>
      </div>
      <div class="overflow-hidden rounded-xl">
        <Image src={image.src} alt={image.alt} class="w-full" />
      </div>
    </header>

    <div class="flex flex-col gap-8 lg:flex-row">
      <div
        class="prose dark:prose-invert prose-img:rounded-xl prose-img:shadow min-w-0 max-w-none flex-1"
      >
        <slot />
      </div>
      <aside class="hidden w-56 shrink-0 lg:block">
        <TableOfContents headings={headings} />
      </aside>
    </div>

    <CTA headline={ctaHeadline} />
  </article>
</DefaultLayout>

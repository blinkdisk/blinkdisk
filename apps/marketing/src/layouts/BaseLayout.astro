---
import "@marketing/styles.css";
import ThemeScript from "@marketing/components/ThemeScript.astro";

import inter400 from "@fontsource/inter/files/inter-latin-400-normal.woff2";
import inter500 from "@fontsource/inter/files/inter-latin-500-normal.woff2";
import inter600 from "@fontsource/inter/files/inter-latin-600-normal.woff2";
import inter700 from "@fontsource/inter/files/inter-latin-700-normal.woff2";

export type Props = {
  title?: string;
  description?: string;
  image?: string;
  og?: {
    title?: string;
    image?: string;
  };
  structuredData?: Record<string, unknown> | Record<string, unknown>[];
};

const defaultTitle = "BlinkDisk | Backup and secure your files";
const defaultDescription =
  "BlinkDisk is a desktop application that lets you effortlessly backup all your important files with just a few clicks.";
const defaultImage = `${import.meta.env.MARKETING_URL || "https://blinkdisk.com"}/brand/social.jpg`;
const siteUrl = import.meta.env.MARKETING_URL || "https://blinkdisk.com";

const { title, description, image, og, structuredData } = Astro.props;

const pageTitle = title ? `${title} | BlinkDisk` : defaultTitle;
const pageDescription = description || defaultDescription;
const pageImage = image || defaultImage;

const ogTitle = og?.title || pageTitle;
const ogImage = og?.image ? `${siteUrl}${og.image}` : pageImage;

const posthogKey = import.meta.env.POSTHOG_MARKETING_KEY || "";
const posthogHost = import.meta.env.POSTHOG_API_HOST || "";
const endorselyKey = import.meta.env.ENDORSELY_PUBLIC_KEY || "";
const crispKey = import.meta.env.CRISP_KEY || "";

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "BlinkDisk",
  url: siteUrl,
  logo: `${siteUrl}/brand/logo.png`,
  sameAs: [
    "https://github.com/blinkdisk/blinkdisk",
    "https://twitter.com/blinkdisk",
  ],
  contactPoint: {
    "@type": "ContactPoint",
    email: "support@blinkdisk.com",
    contactType: "customer support",
  },
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "BlinkDisk",
  url: siteUrl,
  description: defaultDescription,
  publisher: {
    "@type": "Organization",
    name: "BlinkDisk",
  },
};

const allStructuredData = [
  organizationSchema,
  websiteSchema,
  ...(Array.isArray(structuredData) ? structuredData : structuredData ? [structuredData] : []),
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Preload fonts -->
    <link rel="preload" href={inter400} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={inter500} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={inter600} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={inter700} as="font" type="font/woff2" crossorigin />

    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />

    <!-- Open Graph -->
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="BlinkDisk" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@blinkdisk" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={pageImage} />


    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="BlinkDisk" />

    <!-- Structured Data (JSON-LD) -->
    {allStructuredData.map((data) => (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(data)} />
    ))}

    <ThemeScript />

    <!-- Endorsely -->
    {endorselyKey && (
      <script is:inline src="https://assets.endorsely.com/endorsely.js" data-endorsely={endorselyKey} async></script>
    )}
  </head>
  <body>
    <slot />

    <!-- PostHog -->
    {posthogKey && (
      <script is:inline define:vars={{ posthogKey, posthogHost }}>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog && window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init rs ls yi ns us ts ss capture calculateEventProperties vs register register_once register_for_session unregister unregister_for_session gs getFeatureFlag getFeatureFlagPayload getFeatureFlagResult isFeatureEnabled reloadFeatureFlags updateFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty fs ds createPersonProfile setInternalOrTestUser ps Qr opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing hs debug M cs getPageViewId captureTraceFeedback captureTraceMetric Kr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init(posthogKey, {
            api_host: posthogHost || 'https://eu.i.posthog.com',
            ui_host: "https://eu.posthog.com",
            defaults: '2025-11-30',
        })
      </script>
    )}

    <!-- Crisp Chat -->
    {crispKey && (
      <script is:inline define:vars={{ crispKey }}>
        window.$crisp=[];
        window.CRISP_WEBSITE_ID=crispKey;
        (function(){
          var d=document;
          var s=d.createElement("script");
          s.src="https://client.crisp.chat/l.js";
          s.async=1;
          d.getElementsByTagName("head")[0].appendChild(s);
        })();
      </script>
    )}
  </body>
</html>
